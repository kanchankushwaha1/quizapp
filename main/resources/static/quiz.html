<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiz</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background:#0b1d3a; color:#fff; }
    .quiz-box { max-width:700px; margin:40px auto; background:#fff; color:#012970; padding:28px; border-radius:12px; }
    .option-box { background:#eef3ff; padding:12px; border-radius:8px; margin-top:10px; cursor:pointer; }
    .selected-option { background:#c7d8ff; border:2px solid #012970; }
    #toastMsg {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #ff4757;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      display: none;
    }
  </style>
</head>
<body>

<div class="quiz-box">
  <h3 id="category-title" class="text-center"></h3>
  <hr/>
  <h5 id="question-text"></h5>
  <div id="options-container"></div>
  <div class="d-grid gap-2 mt-3">
    <button id="nextBtn" class="btn btn-success">Next ➡️</button>
  </div>
</div>

<div id="toastMsg">⚠️ Please choose an answer before continuing!</div>

<script>
function showToast() {
  const toast = document.getElementById('toastMsg');
  toast.style.display = 'block';
  setTimeout(() => toast.style.display = 'none', 2000);
}

function getQueryParam(name) {
  const params = new URLSearchParams(window.location.search);
  return params.get(name);
}

let category = getQueryParam('category') || sessionStorage.getItem('quizCategory');
if (!category) {
  showToast();
  window.location.href = 'start-quiz.html';
}
sessionStorage.setItem('quizCategory', category);
document.getElementById('category-title').innerText = category + ' Quiz';

let questions = [];
let index = 0;
let score = 0;
let selectedIndex = null;

const optionsContainer = document.getElementById('options-container');
const qText = document.getElementById('question-text');
const nextBtn = document.getElementById('nextBtn');

// --- ✅ FIXED FETCH URL HERE
async function loadQuestions() {
  try {
    const res = await fetch(`http://localhost:8080/api/quiz/category/${category}`);
    if (!res.ok) throw new Error("Failed to fetch quiz");
    
    questions = await res.json();

    questions = questions.map(q => ({
      q: q.question,
      options: [q.optiona, q.optionb, q.optionc, q.optiond],
      correctAnswer: q.correct_answer
    }));

    renderQuestion();
  } catch (err) {
    console.error(err);
    qText.innerText = '⚠️ Unable to load quiz questions.';
  }
}

function renderQuestion() {
  const cur = questions[index];
  qText.innerText = `${index + 1}. ${cur.q}`;
  optionsContainer.innerHTML = '';
  cur.options.forEach((opt, i) => {
    const div = document.createElement('div');
    div.className = 'option-box';
    div.innerText = opt;
    div.onclick = () => selectOption(i, div);
    optionsContainer.appendChild(div);
  });
  selectedIndex = null;
}

function selectOption(i, element) {
  selectedIndex = i;
  document.querySelectorAll('.option-box').forEach(el => el.classList.remove('selected-option'));
  element.classList.add('selected-option');
}

nextBtn.addEventListener('click', () => {
  if (selectedIndex === null) {
    showToast();
    return;
  }
  const selected = questions[index].options[selectedIndex];
  if (selected === questions[index].correctAnswer) score++;
  index++;
  if (index >= questions.length) finishQuiz();
  else renderQuestion();
});

function finishQuiz() {
  localStorage.setItem("quizScore", score.toString());
  localStorage.setItem("totalQuestions", questions.length.toString());
  localStorage.setItem("quizCategory", category);
  window.location.href = "result.html";
}

loadQuestions();
</script>

</body>
</html>
